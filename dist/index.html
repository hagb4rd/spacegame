<html>
<head>
<title>spacegame</title>
<script src="https://unpkg.com/ea-webkit@latest/dist/webkit.min.js"></script>
<script src="vector.js"></script>
<script src="actor.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
}
html {
    background-color: #023;
    color: #eee;
}
canvas {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    margin: auto;
    width: 100%;
    height: 100%;
}
</style>    
</head>
<body>
<canvas></canvas> 
<script>

var progress, start, t, actors = [];

var canvas=document.querySelector('canvas');
var ctx=canvas.getContext('2d');




var controls = {
  up: false,
  down: false,
  left: false,
  right: false,
  zoomin: false,
  zoomout: false
}
var mouse = {
    pos: [0,0],
    relative: [0,0],
    angle: 0,
    update(){
      var [x,y]= this.pos;
      this.relative=Vector.subtract(screen.center,this.pos);
      this.relative=[-this.relative[0],this.relative[1]]
      //this.angle=(this.relative.angle+Math.PI/2)%(Math.PI*2);
      this.angle=Vector.angle([this.relative[0],this.relative[1]]);
      //this.angle = 2*Math.PI-angle;
    },
    draw(){
      
    }   
}
var screen = {
    width: window.innerWidth,
    height: window.innerHeight,
    center: [window.innerWidth/2,window.innerHeight/2],
    pos: [0,0],
    zoom: 1,
    maxzoom: 4,
    minzoom: 0.25,
    projectionMatrix: null,
    update() {
      this.pos = typeof(ship)=='undefined' 
        ? Vector.create([0,0])
        : ship.pos;
      this.width = canvas.width = window.innerWidth,
      this.height = canvas.height = window.innerHeight,
      this.center = [window.innerWidth/2,window.innerHeight/2]

      if(controls.zoomin)
        this.zoom += t;
      if(controls.zoomout)
        this.zoom -= t;
      if(this.zoom > this.maxzoom)
        this.zoom = this.maxzoom;
      if(this.zoom < this.minzoom)
        this.zoom = this.minzoom;

      var scale=Matrix.scale2D([this.zoom,-this.zoom])
      var translate=Matrix.translate2D(Vector.add(this.center,Vector.scale(this.zoom,[-this.pos[0],this.pos[1]])));
      this.projectionMatrix = Matrix.product(translate,scale);
    },
    draw() {
      ctx.font = '14pt Arial';
      ctx.strokeStyle = 'red';
      ctx.strokeText(`pos: [${ship.pos[0].toFixed(1)},${ship.pos[1].toFixed(1)}] v: [${ship.velocity[0].toFixed(1)},${ship.velocity[1].toFixed(1)}] angle: ${deg(mouse.angle).toFixed(1)}`, 14, 14);
    }
}
screen.update();
var ship = new Actor();
ship.vertex = [
    [ 30, 0 ], 
    [ -15, 21 ], 
    [ -6, 0 ], 
    [ -15, -21 ]
], 
ship.lines = [
    [0,1,2,3,0]
];
//ship.radius = Vector.create(ship.vertex[0]).size;
ship.acceleration=60;
ship.friction=6;
ship.velocity = Vector.create([0,0]);
ship.maxvelocity = 400;
ship.update = function() {
  this.angle=mouse.angle;
  //friction
  var deltaV = Vector.scale(-1*t/this.friction,this.velocity);
  this.velocity.add(deltaV)
   
  
  if(controls.up) {
    var a = [Math.cos(this.angle)*this.acceleration,Math.sin(this.angle)*this.acceleration];
    var deltaV=Vector.scale(t,a);
    this.velocity.add(deltaV);
    if(this.velocity.size > this.maxvelocity)
      this.velocity.subtract(deltaV);
  }
  
  /*
  if(this.velocity[0]<0)
    this.velocity[0]=0;
  if(this.velocity[1]<0)
    this.velocity[1]=0;
  */
  var deltaPos=Vector.scale(t,this.velocity);
  this.pos.add(deltaPos);
  
  this.compute();
  actors.filter(actor=>actor.detectCollisions).forEach(actor=>{
    if(Actor.isCollision(this, actor)) {
      actor.color="red";
    }
  })
}

var testObject=new Actor();
testObject.detectCollisions=true;
testObject.pos = Vector.create([200,200]);

testObject.vertex = [[10,-20],[-10,-20],[0,20]];
//testObject.radius = Vector.create(testObject.vertex[0]).size;
testObject.lines = [[0,1,2,0]];


resize();
loop();



function loop(time) {

  if (!start) start = time;
  var tempProgress = (time - start) / 1000;
  if(progress) {
    t=tempProgress-progress;
  } else {
    t=0;
  }
  progress = tempProgress;

  ctx.clearRect(0, 0, screen.width, screen.height);
  
  actors = [screen, mouse, testObject];

  actors.push(ship);

  //update
  actors.forEach(actor=>actor.update(t));
  //.. & draw
  actors.forEach(actor=>actor.draw());
  
  requestAnimationFrame(loop);
}


function touch(e) {
  var {pageX:x, pageY:y} = e.originalEvent.touches[0];
  mouse.pos = [x,y];
}

function mousemove(e) {
  var {pageX:x, pageY:y} = e;
  mouse.pos = [x,y];
}

function resize() {
  screen.width = canvas.width = window.innerWidth;
  screen.height = canvas.height = window.innerHeight;
  screen.center = [window.innerWidth/2,window.innerHeight/2];
}

function onkeydown(e){
  //console.log(e);
  if(e.key=='ArrowUp')
    controls.up=true;
  if(e.key=='+')
    if(!controls.zoomout)
      controls.zoomin=true;
  if(e.key=='-')
    if(!controls.zoomin)
      controls.zoomout=true;
}

function onkeyup(e){
  //console.log(e);
  if(e.key=='ArrowUp')
    controls.up=false;
  if(e.key=='+')
    controls.zoomin=false;
  if(e.key=='-')
    controls.zoomout=false;
}

function onclick(e){
  ship.fire();
}

window.addEventListener('resize', resize);
window.addEventListener('touchstart', touch);
window.addEventListener('touchmove', touch);
window.addEventListener('mousemove', mousemove);
document.addEventListener('keydown', onkeydown);
document.addEventListener('keyup', onkeyup);


</script>
</body>
</html>