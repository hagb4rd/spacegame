<html>
<head>
<title>spacegame</title>
<script src="https://unpkg.com/ea-webkit@latest/dist/webkit.min.js"></script>
<script src="vector.js"></script>
<script src="actor.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
}
html {
    background-color: #023;
    color: #eee;
}
canvas {
    position: pos;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    margin: auto;
    width: 100%;
    height: 100%;
}
</style>    
</head>
<body>
<canvas></canvas> 
<script>

var progress, start, t;

var canvas=document.querySelector('canvas');
var ctx=canvas.getContext('2d');
var Actor=module.Actor({
  ctx: ctx
})



var controls = {
  up: false,
  down: false,
  left: false,
  right: false,
  zoomin: false,
  zoomout: false
}
var mouse = {
    pos: [0,0],
    relative: [0,0],
    angle: 0,
    update(){
      var [x,y]= this.pos;
      this.relative=Vector.subtract(this.pos,screen.center);
      //this.angle=(this.relative.angle+Math.PI/2)%(Math.PI*2);
      var angle=(Vector.angle(this.relative)+Math.PI/2)%(Math.PI*2);
      this.angle = 2*Math.PI-angle;
    },
    draw(){
      ctx.font = '14pt Arial';
      ctx.strokeStyle = 'red';
      ctx.strokeText(`t: ${progress.toFixed(2)} x: ${this.relative[0]} y: ${this.relative[1]} angle: ${deg(this.angle).toFixed(1)}`, 14, 14);
    }   
}



var ship = new Actor();
ship.vertex = [
    [ 0, 30 ], 
    [ 21, -15 ], 
    [ 0, -6 ], 
    [ -21, -15 ]
], 
ship.lines = [
    [0,1,2,3,0]
];
ship.velocity = Vector.create([0,0]);
ship.update = function() {
  this.angle=mouse.angle;
  if(controls.up) {
    var a=1;
    var acceleration=[Math.cos(this.angle)*a,Math.sin(this.angle)*a];
    var deltaV=[acceleration[0]*t,acceleration[1]*t];
    this.velocity.add(deltaV);
  }
  var deltaPos=Vector.scale(t,this.velocity);
  this.pos.add(deltaPos);
}

var testObject=new Actor();
testObject.pos = Vector.create([200,200]);
testObject.vertex = [[0,20],[10,-20],[-10,-20]];
testObject.lines = [[0,1,2,0]];

var screen = {
    width: window.innerWidth,
    height: window.innerHeight,
    center: [window.innerWidth/2,window.innerHeight/2],
    pos: [0,0],
    zoom: 1,
    projectionMatrix: null,
    update() {
      this.pos = ship.pos;
      this.width = canvas.width = window.innerWidth,
      this.height = canvas.height = window.innerHeight,
      this.center = [window.innerWidth/2,window.innerHeight/2]
      this.projectionMatrix = new Matrix([
        [this.zoom, 0, this.center[0]+(this.pos[0]*this.zoom)],
        [0, -this.zoom, this.center[1]+(this.pos[1]*this.zoom)],
        [0, 0, this.zoom]
      ]);
    },
    draw() {

    }
}


resize();
loop();



function loop(time) {

  if (!start) start = time;
  var tempProgress = (time - start) / 1000;
  if(progress) {
    t=tempProgress-progress;
  } else {
    t=0;
  }
  progress = tempProgress;

  ctx.clearRect(0, 0, screen.width, screen.height);
  
  var actors = [mouse, ship, testObject, screen];

  //update
  actors.forEach(actor=>actor.update(t));
  //.. & draw
  actors.forEach(actor=>actor.draw());
  
  requestAnimationFrame(loop);
}


function touch(e) {
  var {pageX:x, pageY:y} = e.originalEvent.touches[0];
  mouse.pos = [x,y];
}

function mousemove(e) {
  var {pageX:x, pageY:y} = e;
  mouse.pos = [x,y];
}

function resize() {
  screen.width = canvas.width = window.innerWidth;
  screen.height = canvas.height = window.innerHeight;
  screen.center = [window.innerWidth/2,window.innerHeight/2];
}

function onkeydown(e){
  //console.log(e);
  if(e.key=='ArrowUp')
    controls.up=true;
}

function onkeyup(e){
  //console.log(e);
  if(e.key=='ArrowUp')
    controls.up=false;
}

window.addEventListener('resize', resize);
window.addEventListener('touchstart', touch);
window.addEventListener('touchmove', touch);
window.addEventListener('mousemove', mousemove);
document.addEventListener('keydown', onkeydown);
document.addEventListener('keyup', onkeyup);


</script>
</body>
</html>